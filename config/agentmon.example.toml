# agentmon configuration example
# Copy to agentmon.toml and customize

[database]
path = "~/.local/share/agentmon/events.db"

[pihole]
# Local database path (if Pi-hole is on the same machine or mounted)
# db_path = "/etc/pihole/pihole-FTL.db"

# Remote Pi-hole via SSH (pull model - deprecated in favor of syslog push)
ssh_host = "pihole.local"
ssh_user = "pi"
# ssh_key_path = "~/.ssh/id_ed25519"
remote_db_path = "/etc/pihole/pihole-FTL.db"

batch_size = 1000

[syslog]
# Syslog receiver for push-based collection from edge devices
# More secure than SSH pull - hub holds no credentials to infrastructure

# Port to listen on (use 1514 to avoid requiring root for <1024)
port = 1514

# Protocol: "tcp" (default, recommended), "udp", or "both"
# TCP provides reliable delivery with no gaps in audit trail
protocol = "tcp"

# SECURITY: Bind address controls which network interfaces accept connections
# - "127.0.0.1" (default): Localhost only - most secure, requires local forwarding
# - Specific IP (e.g., "192.168.1.100"): Only that interface - recommended for remote
# - "0.0.0.0": All interfaces - use only with allowed_ips or firewall rules
bind_address = "127.0.0.1"

# SECURITY: IP allowlist - REQUIRED when bind_address is not localhost
# Empty list accepts from all sources (dangerous with 0.0.0.0!)
# allowed_ips = ["192.168.1.2", "192.168.1.3"]

[analyzer]
# Entropy threshold for DGA detection (higher = fewer false positives)
entropy_threshold = 3.5

# Minimum domain length to consider for entropy analysis
entropy_min_length = 10

# Learning mode: only build baseline, don't generate alerts
learning_mode = false

# Alert deduplication: suppress repeat alerts for same (domain, client, type)
# within this window (seconds). Set to 0 to disable.
alert_dedup_window = 600  # 10 minutes

# Known-bad domain patterns (substring match, case-insensitive)
# Organized by threat category - customize for your environment
known_bad_patterns = [
    # === TIER 1: C2 FRAMEWORKS (High confidence) ===
    "c2-",
    "c2server",
    "beacon",
    "team-server",
    "sliver",
    "havoc",
    "mythic",
    "brute-ratel",
    "cobalt-strike",

    # === TIER 1: MALWARE INDICATORS ===
    "malware",
    "botnet",
    "ransomware",
    "rat-",
    "infostealer",
    "stealer-",
    "payload",
    "exploit-",
    "shellcode",

    # === TIER 1: C2 INFRASTRUCTURE ===
    "callback",
    "checkin-",
    "redirector",

    # === TIER 2: DATA EXFILTRATION SERVICES ===
    # These have legitimate uses but are common abuse vectors
    "pastebin",
    "anonfiles",
    "gofile",
    "transfer.sh",

    # === TIER 2: CRYPTO MINING ===
    "stratum",
    "nicehash",
    "minergate",
    "xmr-pool",
    "monero-pool",
    "-mining-pool",

    # === TIER 2: DNS TUNNELING ===
    "dns-tunnel",
    "exfil-",

    # === TIER 3: ANONYMIZATION (uncomment if needed) ===
    # May generate false positives for VPN/privacy users
    # "tor-proxy",
    # "vpn-proxy",
    # "proxychain",
]

# Domains to always ignore (exact match)
allowlist = [
    "localhost",
    # Add trusted domains here
]

# Domain suffixes to ignore
ignore_suffixes = [
    ".local",
    ".lan",
    ".home",
    ".internal",
    ".localdomain",
    ".arpa",
]

[llm]
# LLM classification via Ollama (must have Ollama running locally)
# Enable with: agentmon listen --llm
enabled = false

# Two-tier classification: fast triage, thorough escalation
# Triage model runs on every alert; escalation only for suspicious results
triage_model = "phi3:3.8b"
escalation_model = "gpt-oss:20b"

# Escalate when triage returns these categories
escalation_categories = ["suspicious", "likely_malicious", "dga", "unknown"]

# Also escalate when triage confidence is below this threshold
escalation_confidence_threshold = 0.7

# Downgrade alert severity when LLM classifies domain as benign
# Reduces false positives from heuristic detection (DGA, known-bad patterns)
# Categories: benign/cdn/cloud_provider/api_service → INFO
#             advertising/tracking → LOW
downgrade_enabled = true
downgrade_confidence = 0.8  # Minimum confidence to trust downgrade

# ==============================================================================
# VirusTotal Integration
# ==============================================================================
# Real-time threat intelligence for domain reputation checking.
# VT data is queried during LLM escalation and cached with the classification
# result (24 hours). Failed lookups are negatively cached for 1 hour.
#
# Requires VirusTotal API key (free tier: 4 requests/min, 500/day)
# Get API key at: https://www.virustotal.com/gui/my-apikey
[virustotal]
# API key - SECURITY: Use environment variable instead of config file:
#   export AGENTMON_VIRUSTOTAL_API_KEY="your-api-key-here"
# api_key = "YOUR_API_KEY_HERE"

[alerting]
# Minimum severity to alert on
min_severity = "low"  # info, low, medium, high, critical

[slack]
# Slack incoming webhook for alert notifications
enabled = false

# Webhook URL from Slack App configuration
# Create at: https://api.slack.com/apps → Incoming Webhooks
# webhook_url = "https://hooks.slack.com/services/T.../B.../xxx"
#
# SECURITY: Prefer setting webhook via environment variable instead of config file:
#   export AGENTMON_SLACK_WEBHOOK="https://hooks.slack.com/services/T.../B.../xxx"
# Environment variable takes precedence over config file and auto-enables Slack.

# Minimum severity to notify (info, low, medium, high, critical)
min_severity = "medium"

# =============================================================================
# PARENTAL CONTROLS
# =============================================================================
# Alert when children access restricted content during specified hours.
# Works alongside security monitoring - both run simultaneously.

[parental_controls]
enabled = false

# Map devices (by IP) to policies
# Each device can have one policy; multiple IPs can map to the same device

[[parental_controls.devices]]
name = "alice-laptop"
client_ips = ["192.168.1.50"]
policy = "homework"

[[parental_controls.devices]]
name = "bob-gaming"
client_ips = ["192.168.1.51"]
policy = "after-school"

# Define policies
# Each policy specifies blocked categories, allowed domains, and time rules

[parental_controls.policies.homework]
description = "Strict during homework hours 3-5pm weekdays"
blocked_categories = ["games", "social_media", "video", "ai_tools"]
allowed_domains = ["wikipedia.org", "khanacademy.org", "desmos.com"]
alert_severity = "high"

[[parental_controls.policies.homework.time_rules]]
start = "15:00"
end = "17:00"
days = ["mon", "tue", "wed", "thu", "fri"]

[parental_controls.policies.after-school]
description = "Gaming allowed 6-8pm on weekends only"
blocked_categories = ["social_media", "ai_tools"]
alert_severity = "medium"

[[parental_controls.policies.after-school.time_rules]]
start = "18:00"
end = "20:00"
days = ["sat", "sun"]
# If allowed_categories is set, ONLY these categories are allowed during this window
allowed_categories = ["games", "entertainment", "educational"]

# Available categories for blocking/allowing:
#   games        - Roblox, Fortnite, Minecraft, Steam, etc.
#   social_media - TikTok, Instagram, Discord, Reddit, etc.
#   ai_tools     - ChatGPT, Claude, Copilot, Midjourney, etc.
#   video        - YouTube, Netflix, Twitch, etc.
#   educational  - Wikipedia, Khan Academy, Coursera, etc.
#   shopping     - Amazon, eBay, etc.
#   news         - CNN, BBC, NYTimes, etc.

# =============================================================================
# DEVICE ACTIVITY ANOMALY DETECTION
# =============================================================================
# Learns each device's normal activity hours and alerts when activity occurs
# outside those patterns - without requiring hard-coded time rules.
#
# This is COMPLEMENTARY to parental controls:
#   - Parental controls: Hard-coded rules ("block games 3-5pm")
#   - Device activity: Learned baseline ("alert if active at 3am")
#
# Example use case:
#   Device 192.168.1.50 normally shows DNS activity from 7am-10pm on weekdays.
#   At 3:15 AM on Tuesday, it suddenly starts querying domains.
#   → Alert: "Unusual activity: alice-laptop active at 03:00"

[device_activity]
enabled = false

# Learning period before generating alerts (days)
# During this period, the system observes activity patterns without alerting.
# Recommended: 14 days to capture both weekday and weekend patterns.
learning_days = 14

# Minimum queries in an hour to consider a device "active"
# Lower values are more sensitive but may increase false positives.
activity_threshold = 5

# Minimum samples per time slot before detecting anomalies
# Requires at least this many observations of a time slot before alerting.
min_samples = 7

# Alert severity for activity anomalies
alert_severity = "medium"

# Named devices for better alert messages
# Each device can have a friendly name and be marked as "always_active"
# to skip anomaly detection (useful for servers, NAS, etc.)

[[device_activity.devices]]
name = "alice-laptop"
client_ips = ["192.168.1.50"]

[[device_activity.devices]]
name = "bob-phone"
client_ips = ["192.168.1.51", "192.168.1.52"]  # Multiple IPs (DHCP)

[[device_activity.devices]]
name = "media-server"
client_ips = ["192.168.1.100"]
# Servers expected to be active 24/7 - don't alert on off-hours activity
always_active = true

[[device_activity.devices]]
name = "nas"
client_ips = ["192.168.1.101"]
always_active = true

# =============================================================================
# CLIENT IDENTITY RESOLUTION
# =============================================================================
# Resolves client IPs to hostnames so baselines survive DHCP changes.
# Uses reverse DNS (PTR) lookup with caching and explicit mappings.
#
# Without this, when DHCP reassigns IPs:
#   - alice-laptop's learned domains are now attributed to bob-phone
#   - bob-phone triggers false "new domain" alerts
#   - Detection quality degrades over time
#
# With this enabled, clients are tracked by hostname instead of IP.

[client_resolver]
enabled = false

# DNS server for reverse lookups (usually Pi-hole or local router)
# Leave unset to use system default resolver (/etc/resolv.conf)
# dns_server = "192.168.1.1"

# Cache TTL for resolved hostnames (seconds)
# Higher values reduce DNS load but delay seeing hostname changes
cache_ttl = 3600  # 1 hour

# Strip domain suffix from hostnames
# "alice-laptop.lan" → "alice-laptop"
# "server.home.local" → "server"
strip_suffix = true

# Explicit IP → hostname mappings (highest priority)
# Use for devices that don't register hostnames via DHCP
# These override DNS lookups

# [[client_resolver.mappings]]
# ip = "192.168.1.100"
# name = "media-server"

# [[client_resolver.mappings]]
# ip = "192.168.1.101"
# name = "nas"

# [[client_resolver.mappings]]
# ip = "192.168.1.200"
# name = "iot-hub"

# =============================================================================
# DATA RETENTION POLICY
# =============================================================================
# Automatically clean up old data to manage disk usage.
#
# Tiered storage model:
#   - Raw DNS events: Short retention (investigation, debugging)
#   - Alerts: Medium retention (incident history)
#   - Baselines: Indefinite (bounded by design - max 168 rows per device)
#
# Cleanup runs at startup and then periodically.

[retention]
enabled = false

# Raw DNS events - keep for investigation/debugging
# These grow fastest - 1000s of events per day is typical
dns_events_days = 30

# Alerts - keep for incident history and trend analysis
alerts_days = 90

# Run cleanup at startup and then every N hours
cleanup_interval_hours = 24

# ==============================================================================
# Threat Intelligence Feeds
# ==============================================================================
# Automatically download and check domains against external threat feeds
# Sources: URLhaus (malware/C2), Feodo Tracker (botnets)
[threat_feeds]
enabled = false

# Directory to cache downloaded feeds
cache_dir = "~/.cache/agentmon/feeds"

# How often to refresh feeds (hours)
update_interval_hours = 24

# Alert severity for threat feed matches
alert_severity = "high"
